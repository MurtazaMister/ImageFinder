<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>PhotoPort</span></title>
	<style>
		body {
			font-family: Arial, sans-serif;
			text-align: center;
			padding: 50px;
			background-color: #f8f9fa;
		}
		.search-container {
			display: flex;
			justify-content: center;
			align-items: center;
			margin-bottom: 20px;
		}
		.search-bar {
			width: 300px;
			padding: 10px;
			border: 2px solid #ff9800;
			border-radius: 20px;
			outline: none;
		}
		.search-button {
			padding: 10px 20px;
			margin-left: 10px;
			border: none;
			background-color: #ff9800;
			color: white;
			border-radius: 20px;
			cursor: pointer;
		}
		.toggle-button {
			background: none;
			border: none;
			cursor: pointer;
			font-size: 16px;
			color: #ff9800;
			display: flex;
			align-items: center;
			margin: auto;
		}
		.arrow {
			display: inline-block;
			transition: transform 0.3s ease;
			margin-left: 5px;
		}
		.rotated {
			transform: rotate(180deg);
		}
		.advanced-options {
			margin-top: 10px;
			display: none;
			text-align: center;
			margin-left: auto;
			margin-right: auto;
			padding: 10px;
			border-radius: 8px;
			background: #fff3e0;
		}
		.go-deep-label {
			display: none;
		}
		.go-deep-input {
			width: 30px;
			border: none;
			border-bottom: 2px solid #ff9800;
			text-align: center;
			outline: none;
			display: none;
		}
		.level-warning {
			color: #ff0000;
			font-size: 0.9em;
			margin-top: 5px;
			display: none;
		}
		.layout-container {
			display: flex;
			gap: 20px;
			margin-top: 30px;
			height: calc(100vh - 200px); /* Set a fixed height for the container */
		}
		.sidebar {
			width: 250px;
			background: white;
			border-radius: 8px;
			box-shadow: 0 2px 4px rgba(0,0,0,0.1);
			padding: 15px;
			height: 100%; /* Take full height of container */
			position: sticky; /* Keep sidebar in view while scrolling */
			top: 20px; /* Add some space from the top */
			overflow-x: hidden; /* Prevent horizontal scroll */
		}
		.level-section {
			margin-bottom: 20px;
			max-height: 300px; /* Limit height of each level section */
			overflow-y: auto; /* Enable vertical scroll within levels */
			position: relative; /* For sticky positioning context */
		}
		.level-title {
			font-size: 1.1em;
			color: #333;
			margin-bottom: 10px;
			padding-bottom: 5px;
			border-bottom: 2px solid #ff9800;
			display: flex;
			align-items: center;
			cursor: pointer;
			font-weight: 600;
			position: sticky; /* Make title sticky */
			top: 0; /* Stick to top of level section */
			background: white; /* Ensure title is opaque */
			z-index: 1; /* Keep title above content */
			transition: none; /* Remove transition to prevent orange bar */
		}
		.level-title .count {
			margin-left: 8px;
			color: #666;
			font-size: 0.9em;
		}
		.level-title .arrow {
			margin-left: auto;
			transition: transform 0.3s ease;
		}
		.level-title .arrow.rotated {
			transform: rotate(180deg);
		}
		.category-section {
			margin: 10px 0;
			padding: 10px;
			background: #f8f9fa;
			border-radius: 4px;
			cursor: pointer;
			transition: background-color 0.2s;
			display: none;
		}
		.level-section.expanded .category-section {
			display: block;
		}
		.category-section h3 {
			font-size: 0.9em;
			margin: 0;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
			transition: all 0.3s ease;
		}
		.category-section:hover h3 {
			white-space: normal;
			word-break: break-all;
		}
		.category-section.active {
			background: #ff9800;
			color: white;
		}
		.category-section.active h3 {
			color: white;
		}
		/* Custom scrollbar for level sections */
		.level-section::-webkit-scrollbar {
			width: 6px;
		}
		.level-section::-webkit-scrollbar-track {
			background: #f1f1f1;
			border-radius: 3px;
		}
		.level-section::-webkit-scrollbar-thumb {
			background: #ff9800;
			border-radius: 3px;
		}
		.level-section::-webkit-scrollbar-thumb:hover {
			background: #f57c00;
		}
		.main-content {
			flex: 1;
			background: white;
			border-radius: 8px;
			box-shadow: 0 2px 4px rgba(0,0,0,0.1);
			padding: 20px;
			overflow-y: auto; /* Enable scrolling for main content if needed */
			height: 100%; /* Take full height of container */
		}
		.image-container {
			display: flex;
			flex-wrap: wrap;
			gap: 15px;
			justify-content: center;
		}
		.image-container img {
			border-radius: 4px;
			box-shadow: 0 2px 4px rgba(0,0,0,0.1);
			transition: transform 0.2s;
		}
		.image-container img:hover {
			transform: scale(1.05);
		}
		.image-frame {
			position: relative;
			display: inline-flex;
			justify-content: center;
			align-items: center;
			margin: 10px;
			padding: 10px;
			background: white;
			border-radius: 8px;
			box-shadow: 0 4px 8px rgba(0,0,0,0.1);
			transition: all 0.3s ease;
			width: 220px; /* Fixed width to ensure consistent frames */
			height: 220px; /* Fixed height to ensure consistent frames */
		}
		.image-frame:hover {
			transform: translateY(-5px);
			box-shadow: 0 6px 12px rgba(0,0,0,0.15);
		}
		.image-frame img {
			display: block;
			max-width: 200px;
			max-height: 200px;
			width: auto;
			height: auto;
			object-fit: contain;
			border-radius: 4px;
			cursor: pointer;
		}
		.grab-more-button {
			padding: 10px 20px;
			margin-bottom: 20px;
			border: none;
			background-color: #ff9800;
			color: white;
			border-radius: 20px;
			cursor: pointer;
			font-size: 1em;
			transition: background-color 0.2s;
			display: block;
			margin-left: auto;
			margin-right: auto;
		}
		.grab-more-button:hover {
			background-color: #f57c00;
		}
		.current-url-title {
			margin-bottom: 20px;
			color: #333;
			font-size: 1.2em;
			display: none; /* Hide by default */
			padding: 10px 20px;
			background: #fff3e0;
			border-radius: 8px;
			align-items: center;
			justify-content: space-between; /* Change to space-between to push controls to the right */
			gap: 15px;
		}
		.size-controls {
			display: none; /* Hide by default */
			gap: 5px;
			margin-left: auto; /* Push to the right */
			background: none; /* Remove any background */
		}
		.size-controls button {
			padding: 5px 10px;
			background: #ff9800;
			border: none;
			border-radius: 4px;
			color: white;
			cursor: pointer;
			font-size: 1.2em;
			transition: background-color 0.2s;
			width: 30px; /* Fixed width for both buttons */
			height: 30px; /* Fixed height for both buttons */
			display: flex;
			align-items: center;
			justify-content: center;
		}
		.size-controls button:hover {
			background: #f57c00;
		}
		.current-url-title a {
			color: #ff9800;
			text-decoration: none;
			transition: color 0.2s;
		}
		.current-url-title a:hover {
			color: #f57c00;
			text-decoration: underline;
		}
		.loading-container {
			display: none;
			text-align: center;
			background: rgba(255, 255, 255, 0.9);
			padding: 20px;
			border-radius: 8px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
			margin: 20px auto;
			max-width: 400px;
		}
		.loading-container img {
			width: 100px;
			height: 100px;
			margin-bottom: 15px;
		}
		.loading-container p {
			color: #333;
			font-size: 1.2em;
			margin: 0;
		}
		.modal {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.9);
			z-index: 1000;
			overflow: hidden;
		}
		.modal-content {
			position: relative;
			width: 100%;
			height: 100%;
			display: flex;
			justify-content: center;
			align-items: center;
		}
		.modal-image {
			max-width: 90%;
			max-height: 90vh;
			object-fit: contain;
			transition: transform 0.3s ease;
		}
		.modal-close {
			position: absolute;
			top: 20px;
			right: 20px;
			color: white;
			font-size: 30px;
			cursor: pointer;
			z-index: 1001;
		}
		.modal-controls {
			position: absolute;
			bottom: 20px;
			left: 50%;
			transform: translateX(-50%);
			display: flex;
			gap: 10px;
			z-index: 1001;
		}
		.modal-controls button {
			padding: 8px 16px;
			background: rgba(255, 255, 255, 0.2);
			border: none;
			border-radius: 4px;
			color: white;
			cursor: pointer;
			transition: background 0.3s ease;
		}
		.modal-controls button:hover {
			background: rgba(255, 255, 255, 0.3);
		}
		.modal-link {
			position: absolute;
			top: 20px;
			right: 60px;
			color: white;
			text-decoration: none;
			background: rgba(255, 255, 255, 0.2);
			padding: 8px 16px;
			border-radius: 4px;
			transition: background 0.3s ease;
		}
		.modal-link:hover {
			background: rgba(255, 255, 255, 0.3);
		}
		.modal-image-name {
			position: absolute;
			top: 20px;
			left: 20px;
			color: white;
			background: rgba(255, 255, 255, 0.2);
			padding: 8px 16px;
			border-radius: 4px;
			font-size: 1.1em;
			max-width: 50vw; /* Limit to half the viewport width */
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
			text-align: left;
			z-index: 1002; /* Ensure it's above the modal image */
		}
	</style>
</head>
<body>
<h1>Photo<span style="font-weight: bold; color: orange;">port</span></h1>

<div class="loading-container" id="loading-container">
	<img src="https://cdn.pixabay.com/animation/2022/10/11/03/16/03-16-39-160_512.gif" alt="Loading">
	<p>Processing...</p>
</div>

<button class="grab-more-button" id="grab-more-button" style="display: none;">Grab More Images</button>
<div class="current-url-title" id="current-url-title">
	<a href="#" target="_blank"></a>
	<div class="size-controls">
		<button onclick="adjustFrameSize('decrease')">-</button>
		<button onclick="adjustFrameSize('increase')">+</button>
	</div>
</div>

<form id="search-form">
	<div class="search-container">
		<input type="text" class="search-bar" placeholder="Enter a url..." name="url">
		<button type="submit" class="search-button">Grab Images</button>
	</div>

	<button type="button" class="toggle-button" onclick="toggleOptions()">
		Advanced Options <span id="arrow" class="arrow">â–¼</span>
	</button>

	<div class="advanced-options" id="advanced-options">
		<div class="options-container">
			<label>
				<input type="checkbox" id="recurse" name="recursive" onclick="showGoDeep()"> Scrape other pages within this url
			</label>
			<label class="go-deep-label" id="go-deep-label">
				,&nbsp;go deep by
				<input type="number" min="0" id="go-deep-input" class="go-deep-input" name="recursiveLevels" onchange="checkRecursiveLevel()">
				levels
			</label>
			<div class="level-warning" id="level-warning">Higher levels will result in the scraping of a large number of images, leading to significant wait times!</div>
		</div>
	</div>
</form>

<div class="layout-container">
	<div class="sidebar">
		<div class="level-section expanded">
			<h2 class="level-title">
				Level 1
				<span class="count">(2 items)</span>
				<span class="arrow rotated">â–¼</span>
			</h2>
			<div class="category-section" data-category="https://cytronics.ca/en/a-propos/#history/">
				<h3>https://cytronics.ca/en/a-propos/#history/</h3>
			</div>
			<div class="category-section" data-category="https://cytronics.ca/en/vision/">
				<h3>https://cytronics.ca/en/vision/</h3>
			</div>
		</div>
		<div class="level-section">
			<h2 class="level-title">
				Level 2
				<span class="count">(1 item)</span>
				<span class="arrow">â–¼</span>
			</h2>
			<div class="category-section" data-category="https://cytronics.ca/en/about/">
				<h3>https://cytronics.ca/en/about/</h3>
			</div>
		</div>
		<div class="level-section">
			<h2 class="level-title">
				Level 3
				<span class="count">(1 item)</span>
				<span class="arrow">â–¼</span>
			</h2>
			<div class="category-section" data-category="https://cytronics.ca/en/contact/">
				<h3>https://cytronics.ca/en/contact/</h3>
			</div>
		</div>
	</div>
	<div class="main-content">
		<div class="image-container" id="image-container">
			<!-- Images will be displayed here -->
		</div>
	</div>
</div>

<div class="modal" id="image-modal">
	<div class="modal-content">
		<span class="modal-close">&times;</span>
		<div class="modal-image-name" id="modal-image-name"></div>
		<img class="modal-image" id="modal-image" src="" alt="Full size image">
		<div class="modal-controls">
			<button onclick="zoomIn()">Zoom In</button>
			<button onclick="zoomOut()">Zoom Out</button>
			<button onclick="resetZoom()">Reset</button>
		</div>
		<a class="modal-link" id="modal-link" href="#" target="_blank">Open Image</a>
	</div>
</div>

<script>
	function toggleOptions() {
		const options = document.getElementById('advanced-options');
		const arrow = document.getElementById('arrow');
		if (options.style.display === 'none' || options.style.display === '') {
			options.style.display = 'block';
			arrow.classList.add('rotated');
		} else {
			options.style.display = 'none';
			arrow.classList.remove('rotated');
		}
	}

	function showGoDeep() {
		const input = document.getElementById('go-deep-input');
		const label = document.getElementById('go-deep-label');
		const warning = document.getElementById('level-warning');

		if(document.getElementById('recurse').checked) {
			label.style.display = 'inline';
			input.style.display = 'inline';
			checkRecursiveLevel(); // Check initial value
		}
		else {
			label.style.display = 'none';
			input.style.display = 'none';
			warning.style.display = 'none';
		}
	}

	function checkRecursiveLevel() {
		const input = document.getElementById('go-deep-input');
		const warning = document.getElementById('level-warning');
		
		if (input.value > 2) {
			warning.style.display = 'block';
		} else {
			warning.style.display = 'none';
		}
	}

    function isValidURL(url) {
        try {
            new URL(url);
            return true;
        } catch(e) {
            return false;
        }
    }

    function apiCallBack(xhr, callback) {
        if (xhr.readyState == XMLHttpRequest.DONE) {
            if (xhr.status != 200) {
                let message = xhr.status + ":" + xhr.statusText + ":" + xhr.responseText;
                alert(message);
                throw 'API call returned bad code: ' + xhr.status;
            }
            let response = xhr.responseText ? JSON.parse(xhr.responseText) : null;
            if (callback) {
                callback(response);
            }
        }
    }

    function enableForm() {
        const form = document.getElementById('search-form');
        const submitButton = form.querySelector('.search-button');
        form.style.display = 'block';
        submitButton.disabled = false;
        document.getElementById('current-url-title').style.display = 'none';
        document.getElementById('grab-more-button').style.display = 'none';
        document.getElementById('loading-container').style.display = 'none';
    }

    function makeApiCall(url, method, obj, callback) {
        let xhr = new XMLHttpRequest();
        let responseMap = {};
        let timeoutId;
        
        // Function to reset timeout
        function resetTimeout() {
            if (timeoutId) {
                clearTimeout(timeoutId);
            }
            timeoutId = setTimeout(() => {
                alert('Request timed out after 17.5 seconds of inactivity. The server took too long to respond.');
                enableForm(); // Re-enable the form
            }, 17500);
        }
        
        // Show loading indicator
        document.getElementById('loading-container').style.display = 'block';
        
        // Initial timeout setup
        resetTimeout();
        
        xhr.open(method, url);
        
        // Handle network errors
        xhr.onerror = function() {
            clearTimeout(timeoutId);
            alert('Network error occurred. Please check your connection and try again.');
            enableForm(); // Re-enable the form
        };
        
        xhr.onreadystatechange = function() {
            if (xhr.readyState === XMLHttpRequest.LOADING) {
                try {
                    const currentResponse = xhr.responseText;
                    if (currentResponse.trim()) {
                        const chunks = currentResponse.split('\n');
                        chunks.forEach(chunk => {
                            if (chunk.trim()) {
                                try {
                                    const data = JSON.parse(chunk);
                                    responseMap = { ...responseMap, ...data };
                                    updateList(responseMap);
                                    // Reset timeout with each successful chunk
                                    resetTimeout();
                                } catch (e) {
                                    console.error('Error parsing chunk:', e);
                                    enableForm(); // Re-enable form on parsing error
                                }
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error processing response:', error);
                    enableForm(); // Re-enable form on processing error
                }
            } else if (xhr.readyState === XMLHttpRequest.DONE) {
                clearTimeout(timeoutId);
                // Hide loading indicator
                document.getElementById('loading-container').style.display = 'none';
                
                if (xhr.status !== 200) {
                    let message = xhr.status + ":" + xhr.statusText + ":" + xhr.responseText;
                    alert(message);
                    enableForm(); // Re-enable the form
                    throw 'API call returned bad code: ' + xhr.status;
                }
                // Only show success if we actually received some data
                if (Object.keys(responseMap).length > 0) {
                    // Show the grab more button after successful processing
                    document.getElementById('grab-more-button').style.display = 'block';
                } else {
                    alert('No images were found or the connection was interrupted.');
                    enableForm(); // Re-enable the form only if no data was received
                }
            }
        };
        
        // Disable the submit button while processing
        const submitButton = document.querySelector('.search-button');
        submitButton.disabled = true;
        
        xhr.send(obj ? obj instanceof FormData || obj.constructor == String ? obj : JSON.stringify(obj) : null);
        
        window.responseMap = responseMap;
    }

    let currentZoom = 1;
    const modal = document.getElementById('image-modal');
    const modalImage = document.getElementById('modal-image');
    const modalLink = document.getElementById('modal-link');
    const modalClose = document.querySelector('.modal-close');

    function zoomIn() {
        currentZoom = Math.min(currentZoom + 0.2, 3);
        modalImage.style.transform = `scale(${currentZoom})`;
    }

    function zoomOut() {
        currentZoom = Math.max(currentZoom - 0.2, 0.5);
        modalImage.style.transform = `scale(${currentZoom})`;
    }

    function resetZoom() {
        currentZoom = 1;
        modalImage.style.transform = `scale(${currentZoom})`;
    }

    let currentFrameSize = 220; // Default frame size

    function adjustFrameSize(action) {
        const frames = document.querySelectorAll('.image-frame');
        const sizeChange = 20; // Amount to change size by
        
        if (action === 'increase') {
            currentFrameSize = Math.min(currentFrameSize + sizeChange, 400);
        } else {
            currentFrameSize = Math.max(currentFrameSize - sizeChange, 120);
        }
        
        frames.forEach(frame => {
            frame.style.width = `${currentFrameSize}px`;
            frame.style.height = `${currentFrameSize}px`;
            
            // Adjust image size within frame
            const img = frame.querySelector('img');
            if (img) {
                img.style.maxWidth = `${currentFrameSize - 20}px`;
                img.style.maxHeight = `${currentFrameSize - 20}px`;
            }
        });
    }

    function displayImages(images) {
        const imageContainer = document.getElementById('image-container');
        imageContainer.innerHTML = '';
        
        // Hide all elements first
        document.getElementById('search-form').style.display = 'none';
        document.getElementById('loading-container').style.display = 'none';
        document.getElementById('grab-more-button').style.display = 'none';
        
        // Re-enable the submit button
        const submitButton = document.querySelector('.search-button');
        submitButton.disabled = false;
        
        const grabMoreButton = document.getElementById('grab-more-button');
        const currentUrlTitle = document.getElementById('current-url-title');
        
        // Update and show the title with link
        currentUrlTitle.querySelector('a').href = images.url;
        currentUrlTitle.querySelector('a').textContent = images.url || 'Images';
        currentUrlTitle.style.display = 'flex';
        
        // Show the size controls
        currentUrlTitle.querySelector('.size-controls').style.display = 'flex';
        
        // Show the grab more button
        grabMoreButton.style.display = 'block';
        
        // Convert images object to array and sort by index, filter out undefined URLs
        const imageList = Object.entries(images)
            .map(([_, imageData]) => imageData)
            .filter(imageData => imageData && imageData.imageUrl); // Filter out undefined/null entries
        
        imageList.forEach(imageData => {
            const frame = document.createElement('div');
            frame.className = 'image-frame';
            frame.style.width = `${currentFrameSize}px`;
            frame.style.height = `${currentFrameSize}px`;
            
            const img = document.createElement('img');
            img.style.maxWidth = `${currentFrameSize - 20}px`;
            img.style.maxHeight = `${currentFrameSize - 20}px`;
            img.src = imageData.imageUrl;
            img.alt = 'Image';
            
            // Add click handler for modal
            img.addEventListener('click', () => {
                modalImage.src = imageData.imageUrl;
                modalLink.href = imageData.imageUrl;
                // Extract and display image name, removing query parameters
                const imageName = imageData.imageUrl.split('/').pop().split('?')[0];
                document.getElementById('modal-image-name').textContent = imageName;
                modal.style.display = 'block';
                resetZoom();
            });
            
            frame.appendChild(img);
            imageContainer.appendChild(frame);
        });
    }

    // Modal close handler
    modalClose.addEventListener('click', () => {
        modal.style.display = 'none';
        resetZoom();
    });

    // Close modal when clicking outside the image
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.style.display = 'none';
            resetZoom();
        }
    });

    // Add pan functionality
    let isDragging = false;
    let startX, startY, translateX = 0, translateY = 0;

    modalImage.addEventListener('mousedown', (e) => {
        if (currentZoom > 1) {
            isDragging = true;
            startX = e.clientX - translateX;
            startY = e.clientY - translateY;
        }
    });

    document.addEventListener('mousemove', (e) => {
        if (isDragging) {
            translateX = e.clientX - startX;
            translateY = e.clientY - startY;
            modalImage.style.transform = `scale(${currentZoom}) translate(${translateX}px, ${translateY}px)`;
        }
    });

    document.addEventListener('mouseup', () => {
        isDragging = false;
    });

    // Add event listener for the grab more button
    document.getElementById('grab-more-button').addEventListener('click', function() {
        // Hide all elements first
        document.getElementById('grab-more-button').style.display = 'none';
        document.getElementById('current-url-title').style.display = 'none';
        document.getElementById('loading-container').style.display = 'none';
        
        // Show the form
        document.getElementById('search-form').style.display = 'block';
        
        // Clear the image container
        document.getElementById('image-container').innerHTML = '';
        
        // Reset all form fields
        document.querySelector('.search-bar').value = '';
        document.getElementById('recurse').checked = false;
        document.getElementById('go-deep-input').value = '';
        document.getElementById('go-deep-label').style.display = 'none';
        document.getElementById('go-deep-input').style.display = 'none';
        
        // Reset advanced options
        document.getElementById('advanced-options').style.display = 'none';
        document.getElementById('arrow').classList.remove('rotated');
    });

    function updateList(response) {
        
        // Clear previous images
        const imageContainer = document.getElementById('image-container');
        imageContainer.innerHTML = '';
        
        // Create sidebar structure
        const sidebar = document.querySelector('.sidebar');
        sidebar.innerHTML = '';
        
        // Filter out URLs with empty image lists and group by level
        const levels = {};
        for (const url in response) {
            // Skip if the URL has no images
            if (!response[url].images || Object.keys(response[url].images).length === 0) {
                continue;
            }
            
            const level = response[url].level;
            if (!levels[level]) {
                levels[level] = [];
            }
            levels[level].push({
                url: url,
                images: response[url].images
            });
        }
        
        // Create level sections
        Object.keys(levels).sort((a, b) => a - b).forEach(level => {
            const levelSection = document.createElement('div');
            levelSection.className = 'level-section';
            
            const levelTitle = document.createElement('h2');
            levelTitle.className = 'level-title';
            
            // Add level text
            const levelText = document.createElement('span');
            levelText.textContent = `Level ${level}`;
            levelTitle.appendChild(levelText);
            
            // Add count
            const count = document.createElement('span');
            count.className = 'count';
            const itemCount = levels[level].length;
            count.textContent = `(${itemCount} ${itemCount === 1 ? 'item' : 'items'})`;
            levelTitle.appendChild(count);
            
            // Add dropdown arrow
            const arrow = document.createElement('span');
            arrow.className = 'arrow';
            arrow.textContent = 'â–¼';
            levelTitle.appendChild(arrow);
            
            // Add click handler for dropdown
            levelTitle.addEventListener('click', () => {
                levelSection.classList.toggle('expanded');
                arrow.classList.toggle('rotated');
            });
            
            levelSection.appendChild(levelTitle);
            
            // Add category sections for this level
            levels[level].forEach(category => {
                const categorySection = document.createElement('div');
                categorySection.className = 'category-section';
                categorySection.setAttribute('data-category', category.url);
                
                const categoryTitle = document.createElement('h3');
                categoryTitle.textContent = category.url;
                categorySection.appendChild(categoryTitle);
                
                // Add click handler
                categorySection.addEventListener('click', () => {
                    // Remove active class from all categories
                    document.querySelectorAll('.category-section').forEach(cat => {
                        cat.classList.remove('active');
                    });
                    // Add active class to clicked category
                    categorySection.classList.add('active');
                    
                    // Display images with URL
                    const imagesWithUrl = {
                        ...category.images,
                        url: category.url
                    };
                    displayImages(imagesWithUrl);
                });
                
                levelSection.appendChild(categorySection);
            });
            
            sidebar.appendChild(levelSection);
        });

        // Expand first level by default
        const firstLevel = sidebar.querySelector('.level-section');
        if (firstLevel) {
            firstLevel.classList.add('expanded');
            const firstArrow = firstLevel.querySelector('.arrow');
            if (firstArrow) {
                firstArrow.classList.add('rotated');
            }
        }
    }

    // Handle form submission
    document.getElementById('search-form').addEventListener('submit', function(event) {
        event.preventDefault();

        const urlInput = document.querySelector('.search-bar');
        const recursiveCheckbox = document.getElementById('recurse');
        const recursiveLevelsInput = document.getElementById('go-deep-input');

        const url = urlInput.value;
        const recursive = recursiveCheckbox.checked;
        const recursiveLevels = recursiveLevelsInput.value || '0';

        if (isValidURL(url)) {
            // Hide all elements first
            document.getElementById('search-form').style.display = 'none';
            document.getElementById('grab-more-button').style.display = 'none';
            document.getElementById('current-url-title').style.display = 'none';
            
            // Show loading
            document.getElementById('loading-container').style.display = 'block';
            
            let urlWithParams = `/main?url=${encodeURIComponent(url)}&recursive=${recursive}&recursiveLevels=${recursiveLevels}`;
            makeApiCall(urlWithParams, 'POST', null, updateList);
        } else {
            alert('Please enter a valid URL');
        }
    });

    // Add click handlers to existing level titles and update counts
    document.addEventListener('DOMContentLoaded', function() {
        const levelSections = document.querySelectorAll('.level-section');
        levelSections.forEach(section => {
            const title = section.querySelector('.level-title');
            const arrow = title.querySelector('.arrow');
            const count = title.querySelector('.count');
            
            // Update count based on actual category sections
            const itemCount = section.querySelectorAll('.category-section').length;
            count.textContent = `(${itemCount} ${itemCount === 1 ? 'item' : 'items'})`;
            
            // Add click handler
            title.addEventListener('click', function() {
                section.classList.toggle('expanded');
                arrow.classList.toggle('rotated');
            });
            
            // If section is expanded by default, rotate arrow
            if (section.classList.contains('expanded')) {
                arrow.classList.add('rotated');
            }
        });
    });
</script>
</body>
</html>