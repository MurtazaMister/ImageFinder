<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Photo<span style="font-weight: bold; color: orange;">port</span></title>
	<style>
		body {
			font-family: Arial, sans-serif;
			text-align: center;
			padding: 50px;
			background-color: #f8f9fa;
		}
		.search-container {
			display: flex;
			justify-content: center;
			align-items: center;
			margin-bottom: 20px;
		}
		.search-bar {
			width: 300px;
			padding: 10px;
			border: 2px solid #ff9800;
			border-radius: 20px;
			outline: none;
		}
		.search-button {
			padding: 10px 20px;
			margin-left: 10px;
			border: none;
			background-color: #ff9800;
			color: white;
			border-radius: 20px;
			cursor: pointer;
		}
		.toggle-button {
			background: none;
			border: none;
			cursor: pointer;
			font-size: 16px;
			color: #ff9800;
			display: flex;
			align-items: center;
			margin: auto;
		}
		.arrow {
			display: inline-block;
			transition: transform 0.3s ease;
			margin-left: 5px;
		}
		.rotated {
			transform: rotate(180deg);
		}
		.advanced-options {
			margin-top: 10px;
			display: none;
			text-align: center;
			margin-left: auto;
			margin-right: auto;
			padding: 10px;
			border-radius: 8px;
			background: #fff3e0;
		}
		.go-deep-label {
			display: none;
		}
		.go-deep-input {
			width: 30px;
			border: none;
			border-bottom: 2px solid #ff9800;
			text-align: center;
			outline: none;
			display: none;
		}
		.layout-container {
			display: flex;
			gap: 20px;
			margin-top: 30px;
			height: calc(100vh - 200px); /* Set a fixed height for the container */
		}
		.sidebar {
			width: 250px;
			background: white;
			border-radius: 8px;
			box-shadow: 0 2px 4px rgba(0,0,0,0.1);
			padding: 15px;
			height: 100%; /* Take full height of container */
			position: sticky; /* Keep sidebar in view while scrolling */
			top: 20px; /* Add some space from the top */
			overflow-x: hidden; /* Prevent horizontal scroll */
		}
		.level-section {
			margin-bottom: 20px;
			max-height: 300px; /* Limit height of each level section */
			overflow-y: auto; /* Enable vertical scroll within levels */
			position: relative; /* For sticky positioning context */
		}
		.level-title {
			font-size: 1.1em;
			color: #333;
			margin-bottom: 10px;
			padding-bottom: 5px;
			border-bottom: 2px solid #ff9800;
			display: flex;
			align-items: center;
			cursor: pointer;
			font-weight: 600;
			position: sticky; /* Make title sticky */
			top: 0; /* Stick to top of level section */
			background: white; /* Ensure title is opaque */
			z-index: 1; /* Keep title above content */
			transition: none; /* Remove transition to prevent orange bar */
		}
		.level-title .count {
			margin-left: 8px;
			color: #666;
			font-size: 0.9em;
		}
		.level-title .arrow {
			margin-left: auto;
			transition: transform 0.3s ease;
		}
		.level-title .arrow.rotated {
			transform: rotate(180deg);
		}
		.category-section {
			margin: 10px 0;
			padding: 10px;
			background: #f8f9fa;
			border-radius: 4px;
			cursor: pointer;
			transition: background-color 0.2s;
			display: none;
		}
		.level-section.expanded .category-section {
			display: block;
		}
		.category-section h3 {
			font-size: 0.9em;
			margin: 0;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
			transition: all 0.3s ease;
		}
		.category-section:hover h3 {
			white-space: normal;
			word-break: break-all;
		}
		.category-section.active {
			background: #ff9800;
			color: white;
		}
		.category-section.active h3 {
			color: white;
		}
		/* Custom scrollbar for level sections */
		.level-section::-webkit-scrollbar {
			width: 6px;
		}
		.level-section::-webkit-scrollbar-track {
			background: #f1f1f1;
			border-radius: 3px;
		}
		.level-section::-webkit-scrollbar-thumb {
			background: #ff9800;
			border-radius: 3px;
		}
		.level-section::-webkit-scrollbar-thumb:hover {
			background: #f57c00;
		}
		.main-content {
			flex: 1;
			background: white;
			border-radius: 8px;
			box-shadow: 0 2px 4px rgba(0,0,0,0.1);
			padding: 20px;
			overflow-y: auto; /* Enable scrolling for main content if needed */
			height: 100%; /* Take full height of container */
		}
		.image-container {
			display: flex;
			flex-wrap: wrap;
			gap: 15px;
			justify-content: center;
		}
		.image-container img {
			border-radius: 4px;
			box-shadow: 0 2px 4px rgba(0,0,0,0.1);
			transition: transform 0.2s;
		}
		.image-container img:hover {
			transform: scale(1.05);
		}
		.grab-more-button {
			padding: 10px 20px;
			margin-bottom: 20px;
			border: none;
			background-color: #ff9800;
			color: white;
			border-radius: 20px;
			cursor: pointer;
			font-size: 1em;
			transition: background-color 0.2s;
			display: block;
			margin-left: auto;
			margin-right: auto;
		}
		.grab-more-button:hover {
			background-color: #f57c00;
		}
		.current-url-title {
			margin-bottom: 20px;
			color: #333;
			font-size: 1.2em;
			display: none; /* Hide by default */
			padding: 10px 20px;
			background: #fff3e0;
			border-radius: 8px;
		}
		.current-url-title a {
			color: #ff9800;
			text-decoration: none;
			transition: color 0.2s;
		}
		.current-url-title a:hover {
			color: #f57c00;
			text-decoration: underline;
		}
	</style>
</head>
<body>
<h1>Photo<span style="font-weight: bold; color: orange;">port</span></h1>

<button class="grab-more-button" id="grab-more-button" style="display: none;">Grab More Images</button>
<h2 class="current-url-title" id="current-url-title"></h2>

<form id="search-form">
	<div class="search-container">
		<input type="text" class="search-bar" placeholder="Enter a url..." name="url">
		<button type="submit" class="search-button">Grab Images</button>
	</div>

	<button type="button" class="toggle-button" onclick="toggleOptions()">
		Advanced Options <span id="arrow" class="arrow">▼</span>
	</button>

	<div class="advanced-options" id="advanced-options">
		<div class="options-container">
			<label>
				<input type="checkbox" id="recurse" name="recursive" onclick="showGoDeep()"> Scrape other pages within this url
			</label>
			<label class="go-deep-label" id="go-deep-label">
				,&nbsp;go deep by
				<input type="number" min="0" id="go-deep-input" class="go-deep-input" name="recursiveLevels">
				levels
			</label>
		</div>
	</div>
</form>

<div class="layout-container">
	<div class="sidebar">
		<div class="level-section expanded">
			<h2 class="level-title">
				Level 1
				<span class="count">(2 items)</span>
				<span class="arrow rotated">▼</span>
			</h2>
			<div class="category-section" data-category="https://cytronics.ca/en/a-propos/#history/">
				<h3>https://cytronics.ca/en/a-propos/#history/</h3>
			</div>
			<div class="category-section" data-category="https://cytronics.ca/en/vision/">
				<h3>https://cytronics.ca/en/vision/</h3>
			</div>
		</div>
		<div class="level-section">
			<h2 class="level-title">
				Level 2
				<span class="count">(1 item)</span>
				<span class="arrow">▼</span>
			</h2>
			<div class="category-section" data-category="https://cytronics.ca/en/about/">
				<h3>https://cytronics.ca/en/about/</h3>
			</div>
		</div>
		<div class="level-section">
			<h2 class="level-title">
				Level 3
				<span class="count">(1 item)</span>
				<span class="arrow">▼</span>
			</h2>
			<div class="category-section" data-category="https://cytronics.ca/en/contact/">
				<h3>https://cytronics.ca/en/contact/</h3>
			</div>
		</div>
	</div>
	<div class="main-content">
		<div class="image-container" id="image-container">
			<!-- Images will be displayed here -->
		</div>
	</div>
</div>

<script>
	function toggleOptions() {
		const options = document.getElementById('advanced-options');
		const arrow = document.getElementById('arrow');
		if (options.style.display === 'none' || options.style.display === '') {
			options.style.display = 'block';
			arrow.classList.add('rotated');
		} else {
			options.style.display = 'none';
			arrow.classList.remove('rotated');
		}
	}

	function showGoDeep() {
		const input = document.getElementById('go-deep-input');
		const label = document.getElementById('go-deep-label');

		if(document.getElementById('recurse').checked) {
			label.style.display = 'inline';
			input.style.display = 'inline';
		}
		else {
			label.style.display = 'none';
			input.style.display = 'none';
		}
	}

    function isValidURL(url) {
        try {
            new URL(url);
            return true;
        } catch(e) {
            return false;
        }
    }

    function apiCallBack(xhr, callback) {
        if (xhr.readyState == XMLHttpRequest.DONE) {
            if (xhr.status != 200) {
                let message = xhr.status + ":" + xhr.statusText + ":" + xhr.responseText;
                alert(message);
                throw 'API call returned bad code: ' + xhr.status;
            }
            let response = xhr.responseText ? JSON.parse(xhr.responseText) : null;
            if (callback) {
                callback(response);
            }
        }
    }

    function makeApiCall(url, method, obj, callback) {
        let xhr = new XMLHttpRequest();
        let responseMap = {};
        
        xhr.open(method, url);
        xhr.onreadystatechange = function() {
            if (xhr.readyState === XMLHttpRequest.LOADING) {
                try {
                    // Get the current response text
                    const currentResponse = xhr.responseText;
                    if (currentResponse.trim()) {
                        // Split response by newlines and parse each chunk
                        const chunks = currentResponse.split('\n');
                        chunks.forEach(chunk => {
                            if (chunk.trim()) {
                                try {
                                    const data = JSON.parse(chunk);
                                    // Add the new data to our response map
                                    responseMap = { ...responseMap, ...data };
                                    
                                    // Update the UI with the new data
                                    updateList(responseMap);
                                } catch (e) {
                                    console.error('Error parsing chunk:', e);
                                }
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error processing response:', error);
                }
            } else if (xhr.readyState === XMLHttpRequest.DONE) {
                if (xhr.status !== 200) {
                    let message = xhr.status + ":" + xhr.statusText + ":" + xhr.responseText;
                    alert(message);
                    throw 'API call returned bad code: ' + xhr.status;
                }
                alert('Transfer complete');
            }
        };
        
        xhr.send(obj ? obj instanceof FormData || obj.constructor == String ? obj : JSON.stringify(obj) : null);
        
        // Store the response map for later use
        window.responseMap = responseMap;
    }

    function displayImages(images) {
        const imageContainer = document.getElementById('image-container');
        imageContainer.innerHTML = '';
        
        // Hide the form and show the grab more button and title
        document.getElementById('search-form').style.display = 'none';
        const grabMoreButton = document.getElementById('grab-more-button');
        const currentUrlTitle = document.getElementById('current-url-title');
        
        // Update and show the title with link
        currentUrlTitle.innerHTML = `<a href="${images.url}" target="_blank">${images.url || 'Images'}</a>`;
        currentUrlTitle.style.display = 'block';
        
        // Show the grab more button
        grabMoreButton.style.display = 'block';
        
        // Convert images object to array and sort by index
        const imageList = Object.entries(images)
            .map(([_, imageData]) => imageData);
        
        imageList.forEach(imageData => {
            const img = document.createElement('img');
            img.width = 200;
            img.src = imageData.imageUrl;
            imageContainer.appendChild(img);
        });
    }

    // Add event listener for the grab more button
    document.getElementById('grab-more-button').addEventListener('click', function() {
        // Show the form
        document.getElementById('search-form').style.display = 'block';
        // Hide the title and button
        document.getElementById('current-url-title').style.display = 'none';
        this.style.display = 'none';
        // Clear the image container
        document.getElementById('image-container').innerHTML = '';
        
        // Reset all form fields
        document.querySelector('.search-bar').value = '';
        document.getElementById('recurse').checked = false;
        document.getElementById('go-deep-input').value = '';
        document.getElementById('go-deep-label').style.display = 'none';
        document.getElementById('go-deep-input').style.display = 'none';
        
        // Reset advanced options
        document.getElementById('advanced-options').style.display = 'none';
        document.getElementById('arrow').classList.remove('rotated');
    });

    function updateList(response) {
        console.log('Updating with:', response);
        
        // Clear previous images
        const imageContainer = document.getElementById('image-container');
        imageContainer.innerHTML = '';
        
        // Create sidebar structure
        const sidebar = document.querySelector('.sidebar');
        sidebar.innerHTML = '';
        
        // Group URLs by level
        const levels = {};
        for (const url in response) {
            const level = response[url].level;
            if (!levels[level]) {
                levels[level] = [];
            }
            levels[level].push({
                url: url,
                images: response[url].images
            });
        }
        
        // Create level sections
        Object.keys(levels).sort((a, b) => a - b).forEach(level => {
            const levelSection = document.createElement('div');
            levelSection.className = 'level-section';
            
            const levelTitle = document.createElement('h2');
            levelTitle.className = 'level-title';
            
            // Add level text
            const levelText = document.createElement('span');
            levelText.textContent = `Level ${level}`;
            levelTitle.appendChild(levelText);
            
            // Add count
            const count = document.createElement('span');
            count.className = 'count';
            const itemCount = levels[level].length;
            count.textContent = `(${itemCount} ${itemCount === 1 ? 'item' : 'items'})`;
            levelTitle.appendChild(count);
            
            // Add dropdown arrow
            const arrow = document.createElement('span');
            arrow.className = 'arrow';
            arrow.textContent = '▼';
            levelTitle.appendChild(arrow);
            
            // Add click handler for dropdown
            levelTitle.addEventListener('click', () => {
                levelSection.classList.toggle('expanded');
                arrow.classList.toggle('rotated');
            });
            
            levelSection.appendChild(levelTitle);
            
            // Add category sections for this level
            levels[level].forEach(category => {
                const categorySection = document.createElement('div');
                categorySection.className = 'category-section';
                categorySection.setAttribute('data-category', category.url);
                
                const categoryTitle = document.createElement('h3');
                categoryTitle.textContent = category.url;
                categorySection.appendChild(categoryTitle);
                
                // Add click handler
                categorySection.addEventListener('click', () => {
                    // Remove active class from all categories
                    document.querySelectorAll('.category-section').forEach(cat => {
                        cat.classList.remove('active');
                    });
                    // Add active class to clicked category
                    categorySection.classList.add('active');
                    
                    // Display images with URL
                    const imagesWithUrl = {
                        ...category.images,
                        url: category.url
                    };
                    displayImages(imagesWithUrl);
                });
                
                levelSection.appendChild(categorySection);
            });
            
            sidebar.appendChild(levelSection);
        });

        // Expand first level by default
        const firstLevel = sidebar.querySelector('.level-section');
        if (firstLevel) {
            firstLevel.classList.add('expanded');
            const firstArrow = firstLevel.querySelector('.arrow');
            if (firstArrow) {
                firstArrow.classList.add('rotated');
            }
        }
    }

    // Handle form submission
    document.getElementById('search-form').addEventListener('submit', function(event) {
        event.preventDefault();

        const urlInput = document.querySelector('.search-bar');
        const recursiveCheckbox = document.getElementById('recurse');
        const recursiveLevelsInput = document.getElementById('go-deep-input');

        const url = urlInput.value;
        const recursive = recursiveCheckbox.checked;
        const recursiveLevels = recursiveLevelsInput.value || '0';

        if (isValidURL(url)) {
            let urlWithParams = `/main?url=${encodeURIComponent(url)}&recursive=${recursive}&recursiveLevels=${recursiveLevels}`;
            makeApiCall(urlWithParams, 'POST', null, updateList);
        } else {
            alert('Please enter a valid URL');
        }
    });

    // Add click handlers to existing level titles and update counts
    document.addEventListener('DOMContentLoaded', function() {
        const levelSections = document.querySelectorAll('.level-section');
        levelSections.forEach(section => {
            const title = section.querySelector('.level-title');
            const arrow = title.querySelector('.arrow');
            const count = title.querySelector('.count');
            
            // Update count based on actual category sections
            const itemCount = section.querySelectorAll('.category-section').length;
            count.textContent = `(${itemCount} ${itemCount === 1 ? 'item' : 'items'})`;
            
            // Add click handler
            title.addEventListener('click', function() {
                section.classList.toggle('expanded');
                arrow.classList.toggle('rotated');
            });
            
            // If section is expanded by default, rotate arrow
            if (section.classList.contains('expanded')) {
                arrow.classList.add('rotated');
            }
        });
    });
</script>
</body>
</html>